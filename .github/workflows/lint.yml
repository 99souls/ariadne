name: Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

defaults:
  run:
    shell: bash

jobs:
  resolve-modules:
    name: Resolve Modules
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.resolve.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Resolve module directories
        id: resolve
        run: bash tools/resolve-modules.sh

  golangci:
    name: golangci-lint
    needs: resolve-modules
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.resolve-modules.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: 1.25.1
      - name: golangci-lint (${{ matrix.workdir }})
        uses: golangci/golangci-lint-action@v8.0.0
        with:
          version: v2.5.0
          working-directory: ${{ matrix.workdir }}
          args: ./...
